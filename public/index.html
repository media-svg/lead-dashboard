<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ORA 4X Lead Command Center</title>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: radial-gradient(circle at center, #111 0%, #000 70%);
  color: white;
  text-align: center;
  overflow: hidden;
}

.header {
  position: absolute;
  top: 40px;
  left: 60px;
}

.clock {
  position: absolute;
  top: 40px;
  right: 60px;
  font-size: 22px;
  opacity: 0.8;
}

.main {
  margin-top: 180px;
}

.leads-title {
  letter-spacing: 4px;
  font-size: 32px;
  opacity: 0.7;
}

.leads-count {
  font-size: 160px;
  font-weight: 700;
  margin-top: 10px;
}

.stats-row {
  margin-top: 70px;
  display: flex;
  justify-content: center;
  gap: 80px;
}

.stat-card {
  background: rgba(255,255,255,0.05);
  padding: 35px 70px;
  border-radius: 20px;
  backdrop-filter: blur(8px);
  box-shadow: 0 25px 50px rgba(0,0,0,.6);
  min-width: 320px;
}

.stat-title {
  font-size: 15px;
  letter-spacing: 2px;
  opacity: 0.6;
}

.stat-value {
  font-size: 42px;
  font-weight: 700;
  margin-top: 12px;
  transition: all .3s ease;
}

.footer {
  position: absolute;
  bottom: 30px;
  right: 60px;
  font-size: 12px;
  opacity: 0.4;
}
</style>
</head>

<body>

<div class="header">
  <img src="/logo.png" height="55">
</div>

<div class="clock" id="clock"></div>

<div class="main">
  <div class="leads-title">LEADS WAITING</div>
  <div class="leads-count" id="leadCount">0</div>

  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-title" id="avgTitle">AVG SPEED TO FIRST CALL</div>
      <div class="stat-value" id="avgSpeed">0.0 MIN</div>
    </div>

    <div class="stat-card">
      <div class="stat-title">TOTAL LEADS TODAY</div>
      <div class="stat-value" id="totalToday">0</div>
    </div>
  </div>
</div>

<div class="footer">
  Business Hours: 8:00 AM – 5:00 PM
</div>

<script>

function updateClock(){
  const now = new Date();
  document.getElementById("clock").innerText =
    now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
}
setInterval(updateClock, 1000);
updateClock();

function businessMinutes(start, end){
  const businessStart = 8;
  const businessEnd = 17;

  let minutes = 0;
  let current = new Date(start);

  while (current < end){
    if (
      current.getHours() >= businessStart &&
      current.getHours() < businessEnd &&
      current.getDay() !== 0 &&
      current.getDay() !== 6
    ){
      minutes++;
    }
    current.setMinutes(current.getMinutes() + 1);
  }
  return minutes;
}

function setAvgColor(avg){
  const el = document.getElementById("avgSpeed");

  if (avg <= 5){
    el.style.color = "#2ecc71";
    el.style.textShadow = "0 0 16px rgba(46,204,113,.4)";
  }
  else if (avg <= 15){
    el.style.color = "#f1c40f";
    el.style.textShadow = "0 0 16px rgba(241,196,15,.4)";
  }
  else{
    el.style.color = "#e74c3c";
    el.style.textShadow = "0 0 16px rgba(231,76,60,.4)";
  }
}

async function fetchLeads(){
  const res = await fetch("/leads");
  const leads = await res.json();

  document.getElementById("leadCount").innerText = leads.length;

  const now = new Date();
  const todayStart = new Date();
  todayStart.setHours(0,0,0,0);

  let totalToday = 0;
  let callSpeeds = [];

  leads.forEach(lead => {

    const created = new Date(lead.created_at);

    if (created >= todayStart){
      totalToday++;
    }

    if (lead.first_call_at){
      const firstCall = new Date(lead.first_call_at);
      const mins = businessMinutes(created, firstCall);
      callSpeeds.push(mins);
    }

  });

  document.getElementById("totalToday").innerText = totalToday;

  let avg = 0;
  if (callSpeeds.length > 0){
    avg = callSpeeds.reduce((a,b)=>a+b,0) / callSpeeds.length;
  }

  const dateString = now.toLocaleDateString(undefined, {
    weekday: 'long',
    month: 'long',
    day: 'numeric'
  });

  document.getElementById("avgTitle").innerText =
    `AVG SPEED TO FIRST CALL — ${dateString}`;

  document.getElementById("avgSpeed").innerText =
    avg.toFixed(1) + " MIN";

  setAvgColor(avg);
}

setInterval(fetchLeads, 5000);
fetchLeads();

</script>

</body>
</html>
