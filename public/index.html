<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ORA 4X Lead Command Center</title>

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at center, #1a1a1a 0%, #000000 70%);
      color: white;
      text-align: center;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 30px 50px;
    }

    .logo {
      height: 55px;
    }

    .clock {
      font-size: 22px;
      opacity: 0.8;
    }

    .main-number {
      margin-top: 40px;
    }

    .leads-title {
      font-size: 26px;
      letter-spacing: 4px;
      opacity: 0.6;
    }

    .lead-count {
      font-size: 140px;
      font-weight: 700;
      margin: 10px 0 40px 0;
    }

    .kpi-row {
      display: flex;
      justify-content: center;
      gap: 60px;
      margin-bottom: 60px;
    }

    .kpi-card {
      background: rgba(255,255,255,0.05);
      padding: 30px 60px;
      border-radius: 16px;
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.08);
      min-width: 320px;
    }

    .kpi-label {
      font-size: 14px;
      letter-spacing: 1px;
      opacity: 0.6;
      margin-bottom: 10px;
    }

    .kpi-value {
      font-size: 42px;
      font-weight: 700;
    }

    .green { color: #22c55e; }
    .yellow { color: #facc15; }
    .red { color: #ef4444; }

    .footer {
      position: absolute;
      bottom: 20px;
      right: 40px;
      font-size: 13px;
      opacity: 0.4;
    }

    .lead-list {
      width: 70%;
      margin: 0 auto 60px auto;
    }

    .lead-item {
      background: #16a34a;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 15px;
      font-size: 20px;
      display: flex;
      justify-content: space-between;
    }

    .lead-source {
      font-size: 14px;
      opacity: 0.8;
    }

  </style>
</head>

<body>

  <div class="top-bar">
    <img src="/logo.png" class="logo">
    <div class="clock" id="clock"></div>
  </div>

  <div class="main-number">
    <div class="leads-title">LEADS WAITING</div>
    <div class="lead-count" id="leadCount">0</div>
  </div>

  <div class="kpi-row">

    <div class="kpi-card">
      <div class="kpi-label" id="avgLabel">
        AVG SPEED TO FIRST CALL — 
      </div>
      <div class="kpi-value" id="avgSpeed">0.0 MIN</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-label">
        TOTAL LEADS TODAY
      </div>
      <div class="kpi-value" id="totalToday">0</div>
    </div>

  </div>

  <div class="lead-list" id="leadList"></div>

  <div class="footer">
    Business Hours: 8:00 AM – 5:00 PM
  </div>

<script>

function updateClock() {
  const now = new Date();
  document.getElementById("clock").innerText =
    now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
}
setInterval(updateClock, 1000);
updateClock();

function minutesBetween(start, end) {
  return (end - start) / 60000;
}

function withinBusinessHours(date) {
  const hour = date.getHours();
  return hour >= 8 && hour < 17;
}

function getTodayString() {
  const now = new Date();
  return now.toLocaleDateString(undefined, {
    weekday: 'long',
    month: 'long',
    day: 'numeric'
  });
}

async function loadLeads() {
  const res = await fetch("/leads");
  const leads = await res.json();

  const now = new Date();
  const today = now.toDateString();

  document.getElementById("leadCount").innerText = leads.length;

  const leadList = document.getElementById("leadList");
  leadList.innerHTML = "";

  let totalToday = 0;
  let totalMinutes = 0;
  let counted = 0;

  leads.forEach(lead => {
    const created = new Date(lead.createdAt);

    if (created.toDateString() === today) {
      totalToday++;
    }

    if (lead.calledAt) {
      const called = new Date(lead.calledAt);

      if (created.toDateString() === today && withinBusinessHours(created)) {
        totalMinutes += minutesBetween(created, called);
        counted++;
      }
    }

    const div = document.createElement("div");
    div.className = "lead-item";
    div.innerHTML = `
      <div>
        ${lead.name}
        <div class="lead-source">${lead.source || "Unknown Source"}</div>
      </div>
      <div>${Math.floor(minutesBetween(created, now))} min</div>
    `;
    leadList.appendChild(div);
  });

  document.getElementById("totalToday").innerText = totalToday;

  let avg = counted > 0 ? (totalMinutes / counted) : 0;
  document.getElementById("avgSpeed").innerText = avg.toFixed(1) + " MIN";

  const avgElement = document.getElementById("avgSpeed");
  avgElement.classList.remove("green", "yellow", "red");

  if (avg < 5) avgElement.classList.add("green");
  else if (avg < 10) avgElement.classList.add("yellow");
  else avgElement.classList.add("red");

  document.getElementById("avgLabel").innerText =
    "AVG SPEED TO FIRST CALL — " + getTodayString();

}

loadLeads();
setInterval(loadLeads, 10000);

</script>

</body>
</html>
